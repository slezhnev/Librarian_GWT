package ru.lsv.gwtlib.downloader;

import java.util.*;
import java.lang.reflect.Type;

import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonSerializationContext;
import com.google.gson.JsonSerializer;

/**
 * –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –∫–Ω–∏–≥–∏ <br/>
 * –ù–µ—Å–∫–æ–ª—å–∫–æ –¥–æ–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞–±–æ—Ä —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä–æ–≤ –¥–ª—è Gson
 * 
 * @author s.leznev
 */
public class Book {

	public static final String PRIMARY_KEY = "BOOK_ID";

	/**
	 * –ö–ª—é—á –ø—Ä–∏ —Ö—Ä–∞–Ω–µ–Ω–∏–∏
	 */
	private Integer bookId;
	/**
	 * –?–º—è —Ñ–∞–π–ª–∞ —ç—Ç–æ–π –∫–Ω–∏–≥–∏ –≤ zipFileName
	 */
	private String id;
	/**
	 * –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–æ–≤
	 */
	private List<Author> authors;
	/**
	 * –ù–∞–∑–≤–∞–Ω–∏–µ
	 */
	private String title;
	/**
	 * –ñ–∞–Ω—Ä
	 */
	private String genre;
	/**
	 * –Ø–∑—ã–∫
	 */
	private String language;
	/**
	 * –?—Å—Ö–æ–¥–Ω—ã–π —è–∑—ã–∫ (–¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–Ω—ã—Ö –∫–Ω–∏–≥)
	 */
	private String sourceLanguage;
	/**
	 * –ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
	 */
	private String serieName;
	/**
	 * –ù–æ–º–µ—Ä –≤ —Å–µ—Ä–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
	 */
	private Integer numInSerie;
	/**
	 * Zip —Ñ–∞–π–ª, –≥–¥–µ –ª–µ–∂–∏—Ç –∫–Ω–∏–≥–∞
	 */
	private String zipFileName;
	/**
	 * CRC32 –∫–Ω–∏–≥–∏. –ù—É–∂–Ω–æ –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥—É–±–ª–µ–π –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ
	 */
	private Long crc32;
	/**
	 * –í—Ä–µ–º—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–∏–≥–∏ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É
	 */
	private Date addTime;

	/**
	 * –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è –∫ –∫–Ω–∏–≥–µ
	 */
	private String annotation;

	/**
	 * –û—Ç–º–µ—Ç–∫–∞ –æ —Ç–æ–º, —á—Ç–æ –∫–Ω–∏–≥–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
	 */
	private List<LibUser> readed;

	/**
	 * –û—Ç–º–µ—Ç–∫–∞ –æ —Ç–æ–º, —á—Ç–æ –∫–Ω–∏–≥—É –Ω–µ–ø–ª–æ—Ö–æ –±—ã–ª–æ –±—ã –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É
	 * –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
	 */
	private List<LibUser> mustRead;

	/**
	 * –û—Ç–º–µ—Ç–∫–∞ –æ —Ç–æ–º, —á—Ç–æ –∫–Ω–∏–≥–∞ —É–¥–∞–ª–µ–Ω–∞ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ
	 */
	private Boolean deletedInLibrary;
	/**
	 * –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞
	 */
	private Library library;

	public Book() {
		authors = new ArrayList<Author>();
		genre = "";
	}

	public List<Author> getAuthors() {
		return authors;
	}

	public void setAuthors(List<Author> authors) {
		this.authors = authors;
	}

	public String getTitle() {
		return title;
	}

	public void setTitle(String title) {
		this.title = title;
	}

	public String getGenre() {
		return genre;
	}

	public void setGenre(String genre) {
		this.genre = genre;
	}

	public String getLanguage() {
		return language;
	}

	public void setLanguage(String language) {
		this.language = language;
	}

	public String getSourceLanguage() {
		return sourceLanguage;
	}

	public void setSourceLanguage(String sourceLanguage) {
		this.sourceLanguage = sourceLanguage;
	}

	public String getSerieName() {
		return serieName;
	}

	public void setSerieName(String serieName) {
		this.serieName = serieName;
	}

	public Integer getNumInSerie() {
		return numInSerie;
	}

	public void setNumInSerie(Integer numInSerie) {
		this.numInSerie = numInSerie;
	}

	public String formHTMLDescription() {
		StringBuffer str = new StringBuffer(
				"<html><b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b>&nbsp;&nbsp;");
		if (title == null)
			str.append("–ù–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è");
		else
			str.append(title);
		str.append("<br>");
		if (serieName != null) {
			str.append("<b>–°–µ—Ä–∏—è:</b>&nbsp;&nbsp;").append(serieName);
			str.append(" - ");
			if (numInSerie == null)
				str.append("–±/–Ω");
			else
				str.append(numInSerie);
			str.append("<br><br>");
		}
		str.append("<b>–ê–≤—Ç–æ—Ä—ã</b>:<br>");
		for (Author author : authors) {
			str.append(author.makeName()).append("<br>");
		}
		str.append("<br>");
		str.append("<b>–ê—Ä—Ö–∏–≤:</b><br>").append(zipFileName).append("<br>");
		str.append("<b>–?–º—è —Ñ–∞–π–ª–∞:</b><br>").append(id);
		if ((deletedInLibrary != null) && (deletedInLibrary)) {
			str.append("<br><br><b>–£–î–ê–õ–ï–ù–ê –í –ë–?–ë–õ–?–û–¢–ï–ö–ï</b><br>");
		}
		return str.toString();
	}

	public String toLongString() {
		String S = "authors:\n";
		for (Author author : authors) {
			S = S + author + "\n";
		}
		return S + "bookId: " + bookId + " id: " + id + " title: " + title
				+ "\ngenre: " + genre + "\nlang: " + language + "\nsrc-lang: "
				+ sourceLanguage + "\nserieName: " + serieName
				+ "\nnumInSerie: " + numInSerie + "\nzipFile: " + zipFileName
				+ "\nCRC: " + crc32;
	}

	public String toString() {
		StringBuffer str = new StringBuffer();
		if (title == null)
			str.append("–ù–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è");
		else
			str.append(title);
		if ((serieName != null) && (serieName.trim().length() > 0)) {
			str.append(" (").append(serieName).append(" - ");
			if (numInSerie != null)
				str.append(numInSerie);
			else
				str.append("–Ω–µ—Ç");
			str.append(")");
		}
		return str.toString();
	}

	public String getId() {
		return id;
	}

	public void setId(String id) {
		this.id = id;
	}

	public String getZipFileName() {
		return zipFileName;
	}

	public void setZipFileName(String zipFileName) {
		this.zipFileName = zipFileName;
	}

	public Integer getBookId() {
		return bookId;
	}

	public void setBookId(Integer bookId) {
		this.bookId = bookId;
	}

	public Long getCrc32() {
		return crc32;
	}

	public void setCrc32(Long crc32) {
		this.crc32 = crc32;
	}

	@Override
	public int hashCode() {
		return Utils.getHash(bookId) + Utils.getHash(id)
				+ Utils.getHash(authors) + Utils.getHash(title)
				+ Utils.getHash(genre) + Utils.getHash(language)
				+ Utils.getHash(sourceLanguage) + Utils.getHash(serieName)
				+ Utils.getHash(numInSerie) + Utils.getHash(zipFileName)
				+ Utils.getHash(crc32);
	}

	@Override
	public boolean equals(Object some) {
		if (some == null)
			return false;
		if (this == some)
			return true;
		if (!(some instanceof Book))
			return false;
		Book book = (Book) some;
		return Utils.areEqual(this.authors, book.authors)
				&& Utils.areEqual(this.bookId, book.bookId)
				&& Utils.areEqual(this.genre, book.genre)
				&& Utils.areEqual(this.title, book.title)
				&& Utils.areEqual(this.id, book.id)
				&& Utils.areEqual(this.language, book.language)
				&& Utils.areEqual(this.serieName, book.serieName)
				&& Utils.areEqual(this.numInSerie, book.numInSerie)
				&& Utils.areEqual(this.crc32, book.crc32)
				&& Utils.areEqual(this.sourceLanguage, book.sourceLanguage)
				&& Utils.areEqual(this.zipFileName, book.zipFileName);
	}

	public Date getAddTime() {
		return addTime;
	}

	public void setAddTime(Date addTime) {
		this.addTime = addTime;
	}

	public String getAnnotation() {
		return annotation;
	}

	public void setAnnotation(String annotation) {
		this.annotation = annotation;
	}

	public List<LibUser> getReaded() {
		return readed;
	}

	public void setReaded(List<LibUser> readed) {
		this.readed = readed;
	}

	public List<LibUser> getMustRead() {
		return mustRead;
	}

	public void setMustRead(List<LibUser> mustRead) {
		this.mustRead = mustRead;
	}

	/**
	 * –°–æ–∑–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∞ (–∏–ª–∏ "–°–±–æ—Ä–Ω–∏–∫", –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–æ–≤
	 * –Ω–µ—Å–∫–æ–ª—å–∫–æ) –?—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –∫–Ω–∏–≥
	 * 
	 * @return –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∞/–æ–≤
	 */
	public String getAuthorsToString() {
		if (authors.size() >= 1) {
			Author author = authors.get(0);
			return author.makeName().trim();
		} else {
			return "–ë–µ–∑ –∞–≤—Ç–æ—Ä–∞";
		}
	}

	public Boolean getDeletedInLibrary() {
		return deletedInLibrary;
	}

	public void setDeletedInLibrary(Boolean deletedInLibrary) {
		this.deletedInLibrary = deletedInLibrary;
	}

	/**
	 * @return the library
	 */
	public Library getLibrary() {
		return library;
	}

	/**
	 * @param library
	 *            the library to set
	 */
	public void setLibrary(Library library) {
		this.library = library;
	}

	/**
	 * Gson —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä
	 * 
	 * @param userId
	 *            –?–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
	 * @return –°–µ—Ä–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç
	 */
	public JsonObject json(int userId) {
		JsonObject res = new JsonObject();
		res.addProperty("bookId", bookId);
		res.addProperty("id", id);
		res.addProperty("title", title);
		res.addProperty("genre", genre);
		res.addProperty("language", language);
		res.addProperty("sourceLanguage", sourceLanguage);
		res.addProperty("serieName", serieName);
		res.addProperty("numInSerie", numInSerie);
		res.addProperty("zipFileName", zipFileName);
		res.addProperty("crc32", crc32);
		res.addProperty("addTime", addTime.toString());
		res.addProperty("annotation", annotation);
		boolean bReaded = false;
		for (LibUser user : readed) {
			if (userId == user.getId()) {
				bReaded = true;
				break;
			}
		}
		res.addProperty("readed", bReaded);
		boolean bMustRead = false;
		for (LibUser user : mustRead) {
			if (userId == user.getId()) {
				bMustRead = true;
				break;
			}
		}
		res.addProperty("mustRead", bMustRead);
		res.addProperty("deletedInLibrary", deletedInLibrary);
		res.add("library", library.json());
		return res;
	}

	/**
	 * Gson —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä –∫–Ω–∏–≥ —Å –∞–≤—Ç–æ—Ä–∞–º–∏
	 * 
	 * @author s.lezhnev
	 */
	public static class BooksWithAuthorsSerializer implements
			JsonSerializer<Book> {

		/**
		 * –?–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
		 */
		private int userId;

		/**
		 * Default constructor
		 * 
		 * @param userId
		 *            –?–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
		 */
		public BooksWithAuthorsSerializer(int userId) {
			super();
			this.userId = userId;
		}

		@Override
		public JsonElement serialize(Book src, Type typeOfSrc,
				JsonSerializationContext context) {
			JsonObject res = src.json(userId);
			JsonArray authorsArray = new JsonArray();
			for (Author author : src.authors) {
				authorsArray.add(author.json());
			}
			res.add("authors", authorsArray);
			return res;
		}

	}

}
